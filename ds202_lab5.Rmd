---
title: 'DS 202: Lab 5'
author: "Muhammad Khairi Norizan"
date: "11/15/2021"
output: html_document
---

```{r setup, include=FALSE}
# import library 
library(tidyverse)
library(lubridate)
library(ggplot2)
library(dplyr)

# Load Data set
accident <- read.csv("https://raw.githubusercontent.com/xdaiISU/ds202materials/master/hwlabs/fars2017/accident.csv", stringsAsFactors = FALSE)
person <- read.csv("https://raw.githubusercontent.com/xdaiISU/ds202materials/master/hwlabs/fars2017/person.csv", stringsAsFactors = FALSE)
```

## Question 1
Create a data frame containing the persons who are fatally hurt in the accidents (see FARS manual and look up variable `INJ_SEV`)
```{r}
fatallyInjuredPerson <- person %>% filter(INJ_SEV == 4)

head(fatallyInjuredPerson, 10)
```

## Question 2
Create a data frame containing the most dangerous vehicle make in each state. The number of persons fatally hit in the vehicle make is used to assess the non-safety of a make. Make sure to handle the missing values appropriately. (look up variable `MAKE`)
```{r}
# MAKE, STATE, PER_NO, PER_TYPE
# PER_TYPE; 1 = Driver of a Motor Vehicle in Transport, 2 = Passenger of a Motor Vehicle in Transport

dangerousVehicleByState <- fatallyInjuredPerson %>% 
                            filter(PER_TYP %in% c(1,2)) %>% 
                            select(STATE, PER_NO, MAKE, PER_TYP, INJ_SEV) %>% 
                            group_by(STATE, MAKE) %>% 
                            summarize(TotalPersonFatallyHit = sum(PER_NO, na.rm = TRUE)) %>% 
                            slice(which.max(TotalPersonFatallyHit))

print(dangerousVehicleByState)
```

## Question 3
Create a map, and label each state with the most dangerous vehicle. Discuss the definition of the most dangerous vehicle, and what you find from the map. (Hint: Read the description for the `STATE` and `COUNTY` columns in the FARS manual. The state & county codes are Geographic Locator Codes (GLCs) from the General Services Administration's (GSA) publication. Use `readxl::read_xlsx` to read in the GLCs.)
```{r}
states <- map_data("state")

joinedDf <- dangerousVehicleByState %>% left_join(states, by=c("STATE" = "group"))

groupedJoinedDf <- joinedDf %>% group_by(STATE, MAKE) %>% summarize(long=mean(long), lat=mean(lat))

states %>% ggplot(aes(x = long, y = lat)) + 
  geom_polygon(aes(group = group)) +
  geom_text(aes(label=MAKE), color='white', data=groupedJoinedDf)
```

## Question 4
Join the accident and person table (work out which variable(s) to use)
```{r}
personAccident <- person %>% inner_join(accident, by='ST_CASE')
```

## Question 5
Tally the number of accidents by day of the week (`DAY_WEEK`), hour of the day (`HOUR`) and gender (`SEX`). Visualize the results and explain what you find.
```{r}
dayWeek <- personAccident %>% group_by(DAY_WEEK) %>% count() %>% rename(CasesCount = n)
hour <- personAccident %>% group_by(HOUR.x) %>% count() %>% rename(CasesCount = n)
sex <- personAccident %>% group_by(SEX) %>% count() %>% rename(CasesCount = n)

print(sex)
```

## Question 6
Now plot a choropleth map of the number of deaths on a county level. Also explain what you find. 
```{r}
deathCountyLevel <- person %>% filter(INJ_SEV == 6) %>% group_by(COUNTY) %>% summarize(n())

deathCountyLevel
```
/